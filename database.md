# üì¶ Database Design: AI Proposal Generator

---

## 1. Overview

This document outlines the database schema for the AI Proposal Generator backend, supporting session-based proposal creation, updates, and storage.

---

## 2. Main Entities

### üßë‚Äçüíº User (optional, for future auth)
- `id` (int, PK)
- `email` (str, unique)
- `name` (str, optional)

### üóÇÔ∏è ProposalSession
- `session_id` (str, PK)
- `created_at` (datetime)
- `updated_at` (datetime)
- `title` (str, e.g., project_title)
- `progress` (int, e.g., % complete)
- `client_name` (str)
- `project_title` (str)
- `project_goals` (str)
- `timeline` (str)
- `deliverables` (str)
- `technologies` (str)
- `history` (JSON/text, stores Q&A or chat log)
- `status` (str, e.g., active/completed)
- `user_id` (int, FK to User, nullable)

### üìù ProposalSection (optional, for granular updates)
- `id` (int, PK)
- `session_id` (str, FK to ProposalSession)
- `section_name` (str, e.g., "timeline")
- `content` (str)
- `last_updated` (datetime)

---

## 3. Relationships

- **User** (1) ‚ü∂ (M) **ProposalSession**
- **ProposalSession** (1) ‚ü∂ (M) **ProposalSection**

---

## 4. Example ER Diagram

```
[User] 1---* [ProposalSession] 1---* [ProposalSection]
```

---

## 5. Table Definitions (SQLModel Example)

```python
from sqlmodel import SQLModel, Field, Relationship
from typing import Optional, List
from datetime import datetime

class User(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    email: str
    name: Optional[str] = None
    sessions: List["ProposalSession"] = Relationship(back_populates="user")

class ProposalSession(SQLModel, table=True):
    session_id: str = Field(primary_key=True)
    created_at: datetime
    updated_at: datetime
    title: str
    progress: int
    client_name: str
    project_title: str
    project_goals: str
    timeline: str
    deliverables: str
    technologies: str
    history: str
    status: str
    user_id: Optional[int] = Field(default=None, foreign_key="user.id")
    user: Optional[User] = Relationship(back_populates="sessions")
    sections: List["ProposalSection"] = Relationship(back_populates="session")

class ProposalSection(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    session_id: str = Field(foreign_key="proposalsession.session_id")
    section_name: str
    content: str
    last_updated: datetime
    session: ProposalSession = Relationship(back_populates="sections")
```

---

## 6. Notes

- Sessions are now stored in the database using the `ProposalSession` and `ProposalSection` tables.
- Each session is uniquely identified by `session_id` and contains all relevant proposal data, history, and progress.
- For development, use SQLite; for production, migrate to PostgreSQL or Redis as needed.
- `history` can be a JSON/text field storing the Q&A log.
- `ProposalSection` is optional but enables fine-grained section updates.
- Add/remove fields as your API evolves.

---

## 7. Alembic Migration Setup & Usage

### 7.1. Install Alembic

```sh
pip install alembic
```

### 7.2. Initialize Alembic in Your Project

```sh
alembic init alembic
```

This creates an `alembic/` directory and `alembic.ini` config file.

### 7.3. Configure Alembic

- In `alembic.ini`, set your database URL (e.g., `sqlite:///./database.db`).
- In `alembic/env.py`, import your SQLModel metadata:

```python
# ...existing code...
from sqlmodel import SQLModel
from your_project.models import User, ProposalSession, ProposalSection  # adjust import as needed

target_metadata = SQLModel.metadata
# ...existing code...
```

### 7.4. Create and Apply Migrations

**Generate a migration:**
```sh
alembic revision --autogenerate -m "Initial tables"
```

**Apply the migration:**
```sh
alembic upgrade head
```

### 7.5. Notes

- Always review autogenerated migration scripts in `alembic/versions/` before applying.
- Use `alembic revision --autogenerate -m "message"` after model changes.
- For more info, see [Alembic documentation](https://alembic.sqlalchemy.org/en/latest/).

---